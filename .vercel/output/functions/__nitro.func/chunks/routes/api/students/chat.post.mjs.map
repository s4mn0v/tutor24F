{"version":3,"file":"chat.post.mjs","sources":["../../../../../../../../server/api/students/chat.post.ts"],"sourcesContent":null,"names":["genAI","GoogleGenerativeAI","process","env","GEMINI_API_KEY","prisma","PrismaClient","studentContexts","Map","async","getOrCreateStudentContext","userId","has","get","student","estudiante","findUnique","where","id","select","xp","streak","lastLoginDate","Error","newContext","messages","progress","Date","conversationHistory","set","saveStudentContext","context","update","data","retryWithExponentialBackoff","operation","maxRetries","initialDelay","retries","error","status","response","message","includes","delay","Math","pow","console","log","Promise","resolve","setTimeout","generateDefaultTopics","nombre","getMaterialesActualizados","asignaturaId","materials","material","findMany","idAsignatura","orderBy","creadoEn","tipo","url","all","map","analyzed","contenido","model","getGenerativeModel","prompt","topics","generateContent","text","trim","split","filter","topic","title","length","analyzeDocument","selectTopic","getRelatedVideo","axios","params","part","q","type","maxResults","key","YOUTUBE_API_KEY","relevanceLanguage","items","videoId","chat_post","defineEventHandler","event","_a","token","getRequestHeaders","authorization","createError","statusCode","decoded","jwt","verify","JWT_SECRET","TokenExpiredError","findFirst","include","asignatura","usuario","body","readBody","answer","quiz","answerFeedback","xpGained","newStreak","videoEmbed","slice","push","startsWith","selectedTopic","replace","currentTopic","relevantDocument","find","doc","some","toLowerCase","studySession","startTime","concepts","examples","conceptsPrompt","conceptsResult","examplesPrompt","examplesResult","questions","join","result","JSON","parse","generateFinalQuiz","currentQuestion","feedback","userAnswer","isCorrect","toUpperCase","correctAnswer","explanation","checkQuizAnswer","progressUpdate","now","progressIndex","findIndex","p","lastReviewed","masteryLevel","currentProgress","max","min","floor","random","lastLogin","today","toDateString","getTime","updateStudentProgress","documents","nivel","name","completed","inProgress"],"mappings":"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"}