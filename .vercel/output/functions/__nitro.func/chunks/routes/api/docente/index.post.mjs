import{PrismaClient as o,Rol as r}from"@prisma/client";import{d as t,e,c as a,r as i}from"../../../nitro/nitro.mjs";import s from"jsonwebtoken";import"underscore";import"bluebird/js/release/promise";import"base64-js";import"jszip";import"@xmldom/xmldom";import"@xmldom/xmldom/lib/dom";import"xmlbuilder";import"dingbat-to-unicode";import"fs";import"url";import"os";import"path";import"path-is-absolute";import"pdf.js-extract";import"node:http";import"node:https";import"@vercel/kv";import"@iconify/utils";import"consola/core";const n=new o,d=t((async o=>{try{const t=e(o,"authorization");if(!t||!t.startsWith("Bearer "))throw a({statusCode:401,message:"No se proporcionó un token de autenticación válido"});const d=t.split(" ")[1];if(!process.env.JWT_SECRET)throw a({statusCode:500,message:"Error de configuración del servidor: JWT_SECRET no está definido"});let c;try{c=s.verify(d,process.env.JWT_SECRET)}catch(o){throw console.error("Error al verificar el token:",o),a({statusCode:401,message:"Token inválido o expirado"})}const m=await i(o),{title:p,description:u,date:l,asignaturaId:f,importance:h}=m;if(!(p&&u&&l&&f&&h))throw a({statusCode:400,message:"Faltan campos requeridos"});const w=await n.usuario.findUnique({where:{id:c.userId}});if(!w)throw a({statusCode:404,message:"Usuario no encontrado"});if(w.rol!==r.DOCENTE&&w.rol!==r.ADMIN)throw a({statusCode:403,message:"El usuario no tiene permisos para crear recordatorios"});const g=await n.asignatura.findFirst({where:{id:Number.parseInt(f.toString()),activo:!0}});if(!g)throw a({statusCode:404,message:"Asignatura no encontrada o no está activa"});if(w.rol===r.DOCENTE){if(!await n.asignatura.findFirst({where:{id:g.id,idDocente:w.id}}))throw a({statusCode:403,message:"No tienes permiso para crear recordatorios en esta asignatura"})}return await n.recordatorio.create({data:{titulo:p,descripcion:u,fecha:new Date(l),importancia:h,asignaturaId:g.id,creadoPorId:w.id}})}catch(o){if(console.error("Error detallado:",o),o instanceof Error){const r=o.statusCode||500;throw a({statusCode:r,message:o.message})}throw a({statusCode:500,message:"Error desconocido al crear el recordatorio"})}finally{await n.$disconnect()}}));export{d as default};
//# sourceMappingURL=index.post.mjs.map
